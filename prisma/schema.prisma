// D7 Team Dashboard - Database Schema
// Based on Google Sheets structure analysis

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Страны (Перу, Италия Ж, Италия М, Аргентина, Чили)
model Country {
  id           String         @id @default(cuid())
  name         String         @unique
  code         String         @unique // PE, IT_F, IT_M, AR, CL
  currency     String         @default("USDT") // Локальная валюта для конверсии
  isActive     Boolean        @default(true)
  status       String         @default("active") // active, paused, disabled
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  dailyMetrics DailyMetrics[]
  adAccounts   AdAccount[]
  employees    Employee[]
  expenses     Expense[]
  buyerMetrics BuyerMetrics[]
  smmMetrics   SmmMetrics[]
  smmSettings  SmmProjectSettings?
}

// Рекламные кабинеты (ТРАСТ, КРОССГИФ, FBM)
model AdAccount {
  id              String   @id @default(cuid())
  name            String   // ТРАСТ, КРОССГИФ, FBM
  agencyFeeRate   Float    @default(0.08) // Комиссия агентства (9% ТРАСТ, 8% остальные)
  countryId       String
  country         Country  @relation(fields: [countryId], references: [id])
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  dailyAdSpends   DailyAdSpend[]
}

// Ежедневные метрики по стране
model DailyMetrics {
  id                String   @id @default(cuid())
  date              DateTime
  countryId         String
  country           Country  @relation(fields: [countryId], references: [id])

  // === Баланс РК ===
  adAccountBalanceFact    Float    @default(0) // Баланс РК факт
  adAccountBalanceMath    Float    @default(0) // Баланс РК математика
  adAccountDeposit        Float    @default(0) // Внесли на РК

  // === Спенд ===
  totalSpend              Float    @default(0) // Спенд за день (сумма по всем кабинетам)
  spendTrust              Float    @default(0) // Спенд TRUST
  spendCrossgif           Float    @default(0) // Спенд Кросгиф
  spendFbm                Float    @default(0) // Спенд FBM
  agencyFee               Float    @default(0) // Процент агентства от спенда

  // === Доход Приёмка ===
  revenueLocalPriemka     Float    @default(0) // Доход в SOL Приёмка
  revenueUsdtPriemka      Float    @default(0) // Доход в USDT Приёмка
  exchangeRatePriemka     Float    @default(0) // Курс обмена приёмка
  commissionPriemka       Float    @default(0) // Комиссия приёмки (15%)

  // === Доход Наш ===
  revenueLocalOwn         Float    @default(0) // Доход в SOL Наш
  revenueUsdtOwn          Float    @default(0) // Доход в USDT Наш
  exchangeRateOwn         Float    @default(0) // Курс обмена Наш
  commissionExchange      Float    @default(0) // Комиссия обмена

  // === Общий доход/расход ===
  totalRevenueUsdt        Float    @default(0) // Общий доход USDT = revenueUsdtPriemka + revenueUsdtOwn
  totalExpensesUsdt       Float    @default(0) // Общие расходы USDT
  expensesWithoutSpend    Float    @default(0) // Расходы без спенда

  // === Выводы и балансы ===
  withdrawnFromOwn        Float    @default(0) // Выведено с наших реков
  withdrawnFromPriemka    Float    @default(0) // Выведено с приёмки
  balancePriemkaMath      Float    @default(0) // Баланс приёмка математика
  balanceOwnMath          Float    @default(0) // Баланс наша приёмка математика
  balancePriemkaFact      Float    @default(0) // Баланс Приёмка Факт
  balanceOwnFact          Float    @default(0) // Баланс наша приёмка факт

  // === ФД / РД (Фактические данные / Расчётные данные) ===
  fdCount                 Int      @default(0) // ФД КОЛ-ВО
  nfdCount                Int      @default(0) // нФД КОЛ-ВО
  fdSumLocal              Float    @default(0) // ФД СУММА SOL
  nfdSumLocal             Float    @default(0) // нФД СУММА SOL
  fdSumUsdt               Float    @default(0) // ФД СУММА USDT
  nfdSumUsdt              Float    @default(0) // нФД СУММА USDT
  rdCount                 Int      @default(0) // РД КОЛ-ВО
  rdSumLocal              Float    @default(0) // РД СУММА
  rdSumUsdt               Float    @default(0) // РД СУММА USDT

  // === ФОТ (Фонд оплаты труда) - расчётные значения ===
  payrollRdHandler        Float    @default(0) // ФОТ ОБРАБ РД (4% от суммы)
  payrollFdHandler        Float    @default(0) // Фот обраб ФД (тиры)
  payrollContent          Float    @default(0) // ФОТ КОНТЕНТ
  payrollReviews          Float    @default(0) // ФОТ ОТЗОВ
  payrollDesigner         Float    @default(0) // ФОТ ДИЗАЙНЕР
  payrollBuyer            Float    @default(0) // ФОТ БАЕР (12% от спенда)
  payrollHeadDesigner     Float    @default(0) // ФОТ ХЕД ДИЗ (10$ фикс)
  totalPayroll            Float    @default(0) // ОБЩИЙ ФОТ
  unpaidPayroll           Float    @default(0) // Невыплачено ФОТ
  paidPayroll             Float    @default(0) // Выплата ФОТ

  // === Дополнительные расходы ===
  chatterfyCost           Float    @default(0) // Chatterfy
  additionalExpenses      Float    @default(0) // ДОП РАСХОДЫ

  // === Прибыль ===
  netProfitMath           Float    @default(0) // Чистая прибыль математика
  netProfitFact           Float    @default(0) // Чистая прибыль факт
  roi                     Float    @default(0) // ROI%

  // === Метрики воронки (из Дашборда) ===
  clicks                  Int      @default(0) // Клики
  costPerClick            Float    @default(0) // Цена клика
  subscriptions           Int      @default(0) // Подписки
  dialogs                 Int      @default(0) // Диалоги

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  dailyAdSpends           DailyAdSpend[]

  @@unique([date, countryId])
  @@index([date])
  @@index([countryId])
}

// Ежедневный спенд по рекламному кабинету
model DailyAdSpend {
  id              String       @id @default(cuid())
  date            DateTime
  adAccountId     String
  adAccount       AdAccount    @relation(fields: [adAccountId], references: [id])
  dailyMetricsId  String
  dailyMetrics    DailyMetrics @relation(fields: [dailyMetricsId], references: [id])

  spend           Float        @default(0)
  deposit         Float        @default(0) // Внесено на этот кабинет
  balance         Float        @default(0) // Баланс кабинета

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([date, adAccountId])
}

// Сотрудники
model Employee {
  id          String   @id @default(cuid())
  name        String
  role        String   // buyer, content, designer, reviewer, rd_handler, fd_handler, head_designer
  countryId   String?
  country     Country? @relation(fields: [countryId], references: [id])

  // Ставки
  fixedRate      Float?   // Фиксированная ставка (например, 10$ для хед диза)
  percentRate    Float?   // Процентная ставка (например, 12% для баера)
  percentageBase String?  // spend, net_profit, gross_revenue, fd_sum, rd_sum, all_payments

  // === Buyer commission tiers ===
  buyerTier1Threshold   Float?   // Spend threshold for tier 1
  buyerTier1Rate        Float?   // Commission rate for tier 1
  buyerTier2Threshold   Float?   // Spend threshold for tier 2
  buyerTier2Rate        Float?   // Commission rate for tier 2
  buyerTier3Threshold   Float?   // Spend threshold for tier 3
  buyerTier3Rate        Float?   // Commission rate for tier 3
  buyerBonusThreshold   Float?   // Spend threshold for bonus
  buyerBonusAmount      Float?   // Bonus amount when threshold reached

  // === RD Handler commission tiers ===
  rdTier1Threshold      Float?   // RD sum threshold for tier 1
  rdTier1Rate           Float?   // Commission rate for tier 1 (e.g. 0.04 = 4%)
  rdTier2Threshold      Float?   // RD sum threshold for tier 2
  rdTier2Rate           Float?   // Commission rate for tier 2
  rdTier3Threshold      Float?   // RD sum threshold for tier 3
  rdTier3Rate           Float?   // Commission rate for tier 3
  rdBonusThreshold      Float?   // RD sum threshold for bonus
  rdBonusAmount         Float?   // Bonus amount when threshold reached

  // === FD Handler tiers (expanded to 5 tiers) ===
  fdTier1Rate           Float?   // Rate for tier 1 (e.g. < 5 FD)
  fdTier1MaxCount       Int?     // Max FD count for tier 1
  fdTier2Rate           Float?   // Rate for tier 2 (e.g. 5-9 FD)
  fdTier2MaxCount       Int?     // Max FD count for tier 2
  fdTier3Rate           Float?   // Rate for tier 3 (e.g. 10-14 FD)
  fdTier3MaxCount       Int?     // Max FD count for tier 3
  fdTier4Rate           Float?   // Rate for tier 4 (e.g. 15-19 FD)
  fdTier4MaxCount       Int?     // Max FD count for tier 4
  fdTier5Rate           Float?   // Rate for tier 5 (e.g. 20+ FD)
  fdBonusThreshold      Int?     // Threshold for bonus (default 5)
  fdBonus               Float?   // Bonus amount

  // === Additional employee fields ===
  workConditionsJson    Json?    // Complex work conditions as JSON
  notes                 String?  // Additional notes about employee
  startDate             DateTime? // Employment start date
  contractType          String?  // Contract type: full-time, part-time, contractor, etc.

  // Настройки периода выплат
  paymentType     String   @default("buffer")  // buffer, day_to_day, twice_monthly, weekly, monthly
  bufferDays      Int      @default(7)         // Дней буфера (для buffer типа)
  paymentDay1     Int?                         // День выплаты 1 (для twice_monthly: 1-28)
  paymentDay2     Int?                         // День выплаты 2 (для twice_monthly: 1-28)

  // Ручной баланс
  currentBalance  Float    @default(0)         // Текущий баланс к выплате (редактируемый вручную)

  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  payrollRecords PayrollRecord[]
  payments       Payment[]
  buyerMetrics   BuyerMetrics[]
  smmMetrics     SmmMetrics[]
}

// Записи о выплатах ФОТ
model PayrollRecord {
  id          String   @id @default(cuid())
  date        DateTime
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])

  amount      Float
  isPaid      Boolean  @default(false)
  paidAt      DateTime?
  notes       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([employeeId])
}

// Фактические выплаты сотрудникам
model Payment {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  amount          Float
  paymentDate     DateTime
  periodStart     DateTime?
  periodEnd       DateTime?
  nextPaymentDate DateTime?
  notes           String?
  
  paymentType     String   @default("salary")  // salary, bonus, advance, other
  status          String   @default("pending") // pending, paid
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([paymentDate])
  @@index([employeeId])
  @@index([status])
}

// Отдельные расходы (доп. расходы)
model Expense {
  id          String   @id @default(cuid())
  date        DateTime
  countryId   String?
  country     Country? @relation(fields: [countryId], references: [id])

  amount      Float
  description String   // Назначение платежа
  category    String   @default("other")  // payroll, commission, chatterfy, tools, other

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([countryId])
}

// Настройки системы
model Settings {
  id                    String   @id @default(cuid())
  key                   String   @unique
  value                 String
  description           String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// Недельные сводки (агрегированные данные)
model WeeklySummary {
  id              String   @id @default(cuid())
  weekStart       DateTime // Понедельник недели
  weekEnd         DateTime // Воскресенье недели
  countryId       String?  // null = все страны

  totalSpend      Float    @default(0)
  totalRevenue    Float    @default(0)
  totalPayroll    Float    @default(0)
  additionalExp   Float    @default(0)
  pnlMath         Float    @default(0)
  pnlFact         Float    @default(0)
  totalExpenses   Float    @default(0)
  roi             Float    @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([weekStart, countryId])
}

// Месячные сводки
model MonthlySummary {
  id              String   @id @default(cuid())
  year            Int
  month           Int
  countryId       String?  // null = все страны

  totalSpend      Float    @default(0)
  totalRevenue    Float    @default(0)
  totalPayroll    Float    @default(0)
  additionalExp   Float    @default(0)
  pnlMath         Float    @default(0)
  pnlFact         Float    @default(0)
  totalExpenses   Float    @default(0)
  roi             Float    @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([year, month, countryId])
}

// Пользователи системы (аутентификация)
model User {
  id                  String    @id @default(cuid())
  username            String    @unique
  passwordHash        String
  role                String    @default("viewer") // admin, editor, viewer
  email               String?
  mustChangePassword  Boolean   @default(false)
  allowedSections     String[]  @default([]) // Empty array means all sections allowed; sections: dashboard, countries, finance, payroll, import, data-entry, analytics, settings
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

// Сессии пользователей
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// === Настройки SMM планов по проектам (странам) ===
model SmmProjectSettings {
  id                     String   @id @default(cuid())
  countryId              String   @unique
  country                Country  @relation(fields: [countryId], references: [id])
  postsPlanMonthly       Int      @default(0)
  storiesPlanMonthly     Int      @default(0)
  miniReviewsPlanMonthly Int      @default(0)
  bigReviewsPlanMonthly  Int      @default(0)
  postsPlanDaily         Int      @default(0)
  storiesPlanDaily       Int      @default(0)
  miniReviewsPlanDaily   Int      @default(0)
  bigReviewsPlanDaily    Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

// === Сторонние SMM проекты (не привязаны к странам) ===
model SmmProject {
  id                     String   @id @default(cuid())
  name                   String   @unique
  code                   String   @unique
  description            String?
  isActive               Boolean  @default(true)
  postsPlanMonthly       Int      @default(0)
  storiesPlanMonthly     Int      @default(0)
  miniReviewsPlanMonthly Int      @default(0)
  bigReviewsPlanMonthly  Int      @default(0)
  postsPlanDaily         Int      @default(0)
  storiesPlanDaily       Int      @default(0)
  miniReviewsPlanDaily   Int      @default(0)
  bigReviewsPlanDaily    Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  metrics                SmmProjectMetrics[]
}

// === Метрики для сторонних SMM проектов ===
model SmmProjectMetrics {
  id                 String     @id @default(cuid())
  date               DateTime
  projectId          String
  project            SmmProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employeeId         String?
  
  postsPlan          Int        @default(0)
  postsPlanDaily     Int        @default(0)
  postsFactDaily     Int        @default(0)
  postsTotal         Int        @default(0)
  postsRemaining     Int        @default(0)
  
  storiesPlan        Int        @default(0)
  storiesPlanDaily   Int        @default(0)
  storiesFactDaily   Int        @default(0)
  storiesTotal       Int        @default(0)
  storiesRemaining   Int        @default(0)
  
  miniReviewsPlan    Int        @default(0)
  miniReviewsPlanDaily Int      @default(0)
  miniReviewsFactDaily Int      @default(0)
  miniReviewsTotal   Int        @default(0)
  miniReviewsRemaining Int      @default(0)
  
  bigReviewsPlan     Int        @default(0)
  bigReviewsPlanDaily Int       @default(0)
  bigReviewsFactDaily Int       @default(0)
  bigReviewsTotal    Int        @default(0)
  bigReviewsRemaining Int       @default(0)
  
  completionRate     Float      @default(0)
  notes              String?
  
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  
  @@unique([date, projectId])
  @@index([date])
  @@index([projectId])
}

// === БАИНГ (Buying) - Ежедневные метрики по баерам ===
model BuyerMetrics {
  id              String   @id @default(cuid())
  date            DateTime
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  countryId       String
  country         Country  @relation(fields: [countryId], references: [id])
  
  // Основные метрики
  spendManual     Float?   // Общий спенд (вручную)
  spend           Float    @default(0) // Общий спенд (расчётный)
  subscriptions   Int      @default(0) // Подписки
  dialogs         Int      @default(0) // Диалоги
  fdCount         Int      @default(0) // ФД (First Deposit)
  
  // Расчётные метрики
  costPerSubscription  Float    @default(0) // Цена подписки = spend / subscriptions
  costPerFd            Float    @default(0) // Цена ФД = spend / fdCount
  conversionRate       Float    @default(0) // Конверсия % = dialogs / subscriptions * 100
  
  // ЗП (10% от спенда)
  payrollAmount        Float    @default(0) // ЗП за день
  
  // Дополнительные поля
  deskName        String?  // Название деска (Desk1, Desk3, etc.)
  platformName    String?  // Название платформы (Crossgif, FBM, etc.)
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([date, employeeId, countryId])
  @@index([date])
  @@index([employeeId])
  @@index([countryId])
}

// === SMM - План/факт контента ===
model SmmMetrics {
  id              String   @id @default(cuid())
  date            DateTime
  countryId       String
  country         Country  @relation(fields: [countryId], references: [id])
  employeeId      String?  // Контентщик (может быть null для общих данных)
  employee        Employee? @relation(fields: [employeeId], references: [id])
  
  // Посты
  postsPlan       Int      @default(0) // План посты
  postsPlanDaily  Int      @default(0) // План в день
  postsFactDaily  Int      @default(0) // Факт в день
  postsTotal      Int      @default(0) // ИТОГО шт
  postsRemaining  Int      @default(0) // Остаток
  
  // Сторис
  storiesPlan       Int    @default(0) // План сторис
  storiesPlanDaily  Int    @default(0) // План в день
  storiesFactDaily  Int    @default(0) // Факт в день
  storiesTotal      Int    @default(0) // ИТОГО шт
  storiesRemaining  Int    @default(0) // Остаток
  
  // Мини-отзывы
  miniReviewsPlan       Int    @default(0) // План мини-отзывы
  miniReviewsPlanDaily  Int    @default(0) // План в день
  miniReviewsFactDaily  Int    @default(0) // Факт в день
  miniReviewsTotal      Int    @default(0) // ИТОГО шт
  miniReviewsRemaining  Int    @default(0) // Остаток
  
  // Большие отзывы
  bigReviewsPlan       Int    @default(0) // План большие отзывы
  bigReviewsPlanDaily  Int    @default(0) // План в день
  bigReviewsFactDaily  Int    @default(0) // Факт в день
  bigReviewsTotal      Int    @default(0) // ИТОГО шт
  bigReviewsRemaining  Int    @default(0) // Остаток
  
  // Общие метрики выполнения
  completionRate  Float    @default(0) // Процент выполнения плана
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([date, countryId])
  @@index([date])
  @@index([countryId])
  @@index([employeeId])
}
